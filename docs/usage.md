# 功能使用说明

[English](usage_en.md) | 中文

> **Version v3.0.0** - 重构架构，企业级日志，处理器模式

## 启动程序

```bash
go run main.go [content目录路径]
```

启动后会显示精简的交互式菜单界面，支持智能工作流和高性能批量处理。

## v3.0.0 新特性概览

### 🏗️ 处理器架构
- **统一接口**: 所有业务操作都采用标准化处理器接口
- **模块化设计**: 文章、标签、页面、删除操作完全分离
- **错误处理**: 统一的错误处理和恢复机制

### 💾 分层缓存系统
- **标签翻译缓存** (`tag_translations_cache.json`)
- **Slug翻译缓存** (`slug_translations_cache.json`)
- **分类翻译缓存** (`category_translations_cache.json`)

### 📝 企业级日志
- **结构化日志**: JSON格式，便于分析和监控
- **自动轮转**: 日志文件自动压缩和归档
- **性能监控**: 集成操作统计和性能指标
- **多级别输出**: DEBUG/INFO/WARN/ERROR级别控制

## 主菜单功能

### 🚀 快速处理

#### 1. 一键处理全部 (智能自动工作流)
**自动执行**完整的处理流程，采用v3.0.0重构优化的架构：

1. **智能状态分析**: 预检查分层缓存状态和文件结构
2. **批量缓存预热**: 使用分层缓存系统生成全量翻译缓存
3. **标签页面生成**: 采用模板化处理，支持自定义模板
4. **文章Slug优化**: 使用统一HTTP客户端和翻译方法
5. **多语言翻译**: 段落级智能翻译，支持上下文感知

系统会进行智能分析，显示详细的处理预览：
- 📊 分层缓存状态 (标签/Slug/分类缓存)
- 🏷️ 需要处理的标签数量和类型
- 📝 需要添加/更新Slug的文章数量
- 🌐 需要翻译的文章和预估时间
- ⚡ 性能优化建议和批量处理策略
- 📋 企业级日志记录和监控

**注意**: 此功能为完全自动化流程，选择后立即开始执行，无需额外确认。所有操作都会记录到结构化日志中。

### 📊 数据查看模块

#### 2. 标签统计与分析
- **查看所有标签**: 显示所有标签及其使用频率
- **查看特定标签详情**: 输入标签名查看使用该标签的所有文章
- **按频率分组查看**: 
  - 高频标签 (≥5篇文章)
  - 中频标签 (2-4篇文章)  
  - 低频标签 (1篇文章)

#### 3. 分类统计
显示所有分类及其文章数量、占比信息

#### 4. 无标签文章
列出所有没有标签的文章，便于后续添加标签

### 🏷️ 标签页面管理

#### 5. 预览标签页面
- 扫描所有标签并生成翻译预览
- 显示将要创建的目录结构
- 展示新建/更新的页面数量统计

#### 6. 生成标签页面 (高性能批量处理)
采用重构后的标签生成器，支持：
- **智能批量翻译**: 使用统一HTTP客户端，减少网络开销
- **模板化生成**: 支持自定义标签页面模板
- **缓存优化**: 自动检测现有翻译缓存，避免重复请求
- **进度监控**: 实时显示处理进度和性能指标

处理模式：
- **仅新增**: 只为没有页面的标签创建页面
- **仅更新**: 只更新已存在的标签页面  
- **全部处理**: 新建+更新所有标签页面

生成的文件结构：
```
content/tags/
├── 标签名1/
│   └── _index.md
├── 标签名2/
│   └── _index.md
└── ...
```

每个 `_index.md` 包含优化的元数据：
```yaml
---
title: 标签名
slug: "english-slug"
description: 包含 N 篇关于 标签名 的文章
layout: "tag"
---
```

### 📝 内容管理 (重构优化)

#### 2. 生成文章Slug (统一翻译处理)
使用重构后的文章Slug生成器，特色功能：
- **交互式确认**: 处理前会显示预览并要求用户确认
- **统一翻译方法**: 使用 `TranslateToArticleSlug` 专用接口
- **批量优化处理**: 智能分批处理，减少API调用
- **缓存分层管理**: 使用独立的文章缓存，提高命中率
- **智能重试机制**: 失败时自动使用备用翻译策略

为文章添加或更新优化的slug字段：
```yaml
---
title: "我的文章标题"
slug: "my-article-title"
date: 2024-01-01
tags: ["AI", "技术"]
categories: ["开发"]
---
```

#### 4. 翻译文章为多语言 (上下文感知翻译)
采用重构后的翻译引擎，支持：
- **交互式确认**: 翻译前会显示详细预览并要求用户确认
- **段落级翻译**: 保持文章结构完整性
- **上下文感知**: AI理解技术术语和专业词汇
- **格式保留**: 自动保留Markdown格式和代码块
- **批量处理**: 智能分批翻译，优化性能

翻译特色：
- 自动检测需要跳过的内容（代码块、链接等）
- 智能处理中英文混合内容
- 保持原有目录结构和文件关系
- 生成符合Hugo规范的多语言文件

### 💾 缓存管理 (分层架构)

#### 6. 生成全量翻译缓存 (智能批量处理)
采用重构后的批量处理引擎：
- **交互式确认**: 处理前会显示详细预览并要求用户确认
- **分类批量处理**: 分别处理标签和文章翻译
- **智能去重**: 自动检测已有缓存，只翻译缺失项
- **性能优化**: 使用连接池和并发控制
- **进度追踪**: 实时显示翻译进度和统计信息

处理流程：
```
🔍 分析待翻译内容...
📊 发现 45 个标签，89 个文章标题
💾 检查现有缓存...
🔄 需要翻译: 12 个标签，23 个文章标题

🏷️ 批量翻译标签 (12/12) ████████████ 100%
📝 批量翻译文章 (23/23) ████████████ 100%

✅ 批量翻译完成！
  - 新增标签翻译: 12 个
  - 新增文章翻译: 23 个
  - 总耗时: 45.6s
  - 平均每项: 1.3s
```

#### 7. 清空翻译缓存 (精细化管理)
支持分类清空缓存：
- **安全确认**: 清空操作前会要求用户确认
- **标签缓存清空**: 只清空标签翻译缓存
- **文章缓存清空**: 只清空文章翻译缓存
- **全部缓存清空**: 清空所有翻译缓存
- **过期缓存清理**: 自动清理过期的缓存条目

### 📊 性能监控 (企业级)

#### 新增: 查看性能统计
显示详细的性能监控信息：
```
📊 性能统计详情:
🔄 翻译操作:
  - 总翻译次数: 156
  - 标签翻译: 89 次
  - 文章翻译: 67 次
  - 平均响应时间: 1.2s

💾 缓存性能:
  - 总查询次数: 1,234
  - 缓存命中: 1,078 次 (87.4%)
  - 缓存未命中: 156 次 (12.6%)
  - 平均查询时间: 0.02ms

🌐 网络性能:
  - HTTP请求次数: 156
  - 成功率: 98.7% (154/156)
  - 平均请求时间: 1.18s
  - 重试次数: 3

📁 文件操作:
  - 文件读取: 245 次
  - 文件写入: 89 次
  - 缓存保存: 12 次
  - 平均I/O时间: 0.05s

❌ 错误统计:
  - 网络错误: 2 次
  - 翻译错误: 0 次
  - 文件错误: 1 次
  - 总错误率: 1.9%
```

#### 新增: 重置性能统计
清空所有性能统计数据，重新开始监控。

## AI翻译功能 (重构优化)

### 统一翻译架构
采用重构后的翻译器架构：
1. **统一HTTP客户端**: 消除重复代码，提高请求效率
2. **模板化提示词**: 针对不同类型内容使用专门的提示词
3. **智能缓存策略**: 分层缓存管理，提高命中率
4. **错误处理优化**: 智能重试和备用策略

### 翻译方法类型
- **TranslateToSlug**: 标签翻译，生成URL-safe的slug
- **TranslateToArticleSlug**: 文章标题翻译，保持语义准确性
- **TranslateParagraph**: 段落翻译，保持格式和上下文

### 智能内容检测
重构后的内容检测机制：
```go
// 自动跳过不需要翻译的内容
- 代码块 (```包围的内容)
- 缩进代码块 (4空格开头)
- 纯英文内容
- HTML标签
- 图片链接 (但翻译alt文本中的中文)
- 引用块 (但翻译其中的中文内容)
```

### 批量处理优化
- **智能分批**: 根据网络状况和API限制自动调整批量大小
- **缓存预加载**: 提前检查缓存状态，减少重复查询
- **进度监控**: 实时显示翻译进度和预估完成时间
- **错误恢复**: 单个翻译失败不影响整体进程

## 缓存机制 (分层架构)

### 分层缓存设计
```json
// 标签缓存 (cache/tag_cache.json)
{
  "version": "2.0",
  "cache_type": "tag",
  "last_updated": "2024-01-15T14:30:25Z",
  "entries": {
    "人工智能": {
      "translation": "artificial-intelligence",
      "created_at": "2024-01-15T10:00:00Z",
      "updated_at": "2024-01-15T10:00:00Z",
      "hit_count": 15
    }
  },
  "stats": {
    "total_entries": 145,
    "hit_rate": 0.923,
    "avg_hit_count": 8.2
  }
}

// 文章缓存 (cache/article_cache.json)
{
  "version": "2.0", 
  "cache_type": "article",
  "last_updated": "2024-01-15T14:25:12Z",
  "entries": {
    "如何使用AI提升开发效率": {
      "translation": "how-to-improve-development-efficiency-with-ai",
      "created_at": "2024-01-15T09:30:00Z",
      "updated_at": "2024-01-15T09:30:00Z",
      "hit_count": 3
    }
  },
  "stats": {
    "total_entries": 89,
    "hit_rate": 0.876,
    "avg_hit_count": 4.1
  }
}
```

### 缓存性能优化
- **压缩存储**: 自动压缩缓存文件，减少磁盘占用
- **过期管理**: 自动清理过期缓存条目
- **命中率监控**: 实时统计缓存使用效率

## v3.0.0 处理器架构

### 统一处理器接口
所有业务操作都采用标准化的处理器接口设计：

```go
type Processor interface {
    Process() error
    GetType() string
    GetDescription() string
}
```

### 处理器类型

#### 1. 文章处理器 (ArticleProcessor)
- **功能**: 处理文章Slug生成和翻译
- **特点**: 支持批量处理，智能缓存
- **配置**: 可配置并发数和批量大小

#### 2. 页面处理器 (PageProcessor) 
- **功能**: 生成标签和分类页面
- **特点**: 模板化生成，支持自定义模板
- **优化**: 增量更新，只处理变更的页面

#### 3. 删除处理器 (DeleteProcessor)
- **功能**: 安全删除生成的页面和缓存
- **特点**: 预览删除内容，确认后执行
- **保护**: 防止误删除重要文件

### 错误处理机制
- **统一错误处理**: 所有处理器使用相同的错误处理策略
- **错误恢复**: 支持从错误中恢复，继续后续操作
- **详细日志**: 记录详细的错误信息和调用栈

## 日志系统 (企业级)

### 结构化日志格式
```json
{
  "timestamp": "2024-01-15T14:30:25.123Z",
  "level": "INFO",
  "module": "translator",
  "operation": "translate_tag",
  "message": "Tag translation completed",
  "data": {
    "tag": "人工智能",
    "translation": "artificial-intelligence",
    "duration_ms": 1250,
    "cache_hit": false
  },
  "performance": {
    "memory_mb": 45.2,
    "cpu_percent": 12.5,
    "goroutines": 8
  }
}
```

### 日志级别说明
- **DEBUG**: 详细的调试信息，包含函数调用和变量状态
- **INFO**: 一般操作信息，包含处理进度和结果
- **WARN**: 警告信息，非致命错误和性能问题
- **ERROR**: 错误信息，需要用户关注的问题

### 日志轮转配置
```json
{
  "logging": {
    "level": "INFO",
    "file": "./logs/app.log",
    "max_size_mb": 100,     // 单文件最大100MB
    "max_backups": 10,      // 保留10个备份文件
    "max_age_days": 30,     // 保留30天内的日志
    "compress": true,       // 压缩旧日志文件
    "console_output": true  // 同时输出到控制台
  }
}
```

## 高级功能

### 自定义模板支持
v3.0.0支持自定义页面模板：

#### 标签页模板 (templates/tag_page.md)
```markdown
---
title: "{{.Name}} - 标签页"
slug: "{{.Slug}}"
description: "{{.Name}}相关的{{.Count}}篇技术文章"
type: "tag"
layout: "tag"
---

# {{.Name}}

{{.Description}}

> 共收录 **{{.Count}}** 篇关于 {{.Name}} 的文章

## 最新文章

{{range .Articles}}
- [{{.Title}}]({{.URL}}) - {{.Date}}
{{end}}

## 相关标签

{{range .RelatedTags}}
- [{{.Name}}]({{.URL}})
{{end}}
```

#### 分类页模板 (templates/category_page.md)
```markdown
---
title: "{{.Name}} - 分类页"
slug: "{{.Slug}}"
description: "{{.Name}}分类下的{{.Count}}篇文章"
type: "category"
layout: "category"
---

# {{.Name}} 分类

{{.Description}}

## 文章列表 ({{.Count}}篇)

{{range .Articles}}
### [{{.Title}}]({{.URL}})
{{.Summary}}
*发布时间: {{.Date}}* | *标签: {{.Tags}}*

---
{{end}}
```

### 批量操作策略

#### 智能分批处理
```go
// 根据内容量和网络状况自动调整
小型操作 (< 10项):  并发数=2, 批量=5
中型操作 (10-50项): 并发数=3, 批量=10
大型操作 (> 50项):  并发数=5, 批量=20
```

#### 性能监控指标
- **吞吐量**: 每秒处理的条目数
- **延迟**: 单个操作的平均响应时间
- **错误率**: 失败操作的百分比
- **资源使用**: CPU和内存占用情况

### 多语言支持配置

#### 支持的目标语言
```json
{
  "language": {
    "target_languages": ["en", "ja", "ko", "fr", "de", "es"],
    "language_names": {
      "en": "English",
      "ja": "日本語", 
      "ko": "한국어",
      "fr": "Français",
      "de": "Deutsch",
      "es": "Español"
    },
    "fallback_language": "en"
  }
}
```

#### 翻译质量控制
- **术语一致性**: 自动检测和保持专业术语翻译一致性
- **上下文感知**: 根据文章类型调整翻译策略
- **格式保留**: 完美保持Markdown格式和特殊字符
- **质量评估**: 自动评估翻译质量并提供改进建议

## 性能优化建议

### 系统配置优化

#### 硬件配置建议
```
小型博客 (< 100篇):
- CPU: 2核心以上
- 内存: 4GB以上
- 磁盘: SSD 100MB可用空间

中型博客 (100-500篇):
- CPU: 4核心以上  
- 内存: 8GB以上
- 磁盘: SSD 500MB可用空间

大型博客 (> 500篇):
- CPU: 8核心以上
- 内存: 16GB以上
- 磁盘: NVMe SSD 1GB可用空间
```

#### 网络优化配置
```json
{
  "performance": {
    "max_concurrent_requests": 5,
    "request_timeout_seconds": 30,
    "retry_delay_ms": 1000,
    "max_retries": 3,
    "connection_pool_size": 10,
    "keep_alive_seconds": 300
  }
}
```

### 使用建议

#### 首次使用工作流
1. **环境检查**: 确保LM Studio正常运行
2. **配置优化**: 根据博客规模调整性能参数
3. **缓存预热**: 先执行"生成全量翻译缓存"
4. **增量处理**: 使用"一键处理全部"处理新内容
5. **定期维护**: 定期清理过期缓存和日志

#### 日常维护工作流
```bash
# 每日自动化脚本示例
# 1. 清理过期缓存
go run main.go --cleanup-cache

# 2. 检查系统状态  
go run main.go --health-check

# 3. 处理新增内容
go run main.go /path/to/content --auto-process

# 4. 生成统计报告
go run main.go --generate-report
```

#### 最佳实践
- **备份策略**: 定期备份配置文件和缓存数据
- **监控设置**: 配置日志监控和性能告警
- **版本控制**: 将生成的内容纳入Git版本控制
- **测试验证**: 在生产环境前先在测试环境验证

## 故障排除

### 常见问题诊断

#### LM Studio连接问题
```bash
# 检查连接状态
curl -X POST http://localhost:2234/v1/chat/completions \
     -H "Content-Type: application/json" \
     -d '{"model":"test","messages":[{"role":"user","content":"hello"}]}'

# 查看错误日志
grep "LM Studio" logs/app.log | tail -10
```

#### 缓存问题诊断
```bash
# 检查缓存文件完整性
go run main.go --validate-cache

# 重建损坏的缓存
rm *_translations_cache.json
go run main.go --rebuild-cache
```

#### 性能问题诊断
```bash
# 查看性能日志
grep "performance" logs/app.log | tail -20

# 分析内存使用
grep "memory" logs/app.log | tail -10

# 检查磁盘空间
df -h
```

### 错误代码参考
- **E001**: LM Studio连接失败
- **E002**: 配置文件格式错误
- **E003**: 缓存文件损坏
- **E004**: 网络请求超时
- **E005**: 内存不足
- **E006**: 磁盘空间不足
- **E007**: 权限不足

---

## 升级指南

### 从v2.x升级到v3.0.0

#### 1. 备份现有数据
```bash
# 备份配置和缓存
cp config.json config.json.v2.backup
cp translations_cache.json translations_cache.json.v2.backup
```

#### 2. 迁移配置格式
v3.0.0会自动检测旧配置并提示升级：
```bash
go run main.go --migrate-config
```

#### 3. 重建缓存结构
```bash
# 删除旧的单一缓存文件
rm translations_cache.json

# 运行程序自动创建新的分层缓存
go run main.go /path/to/content
```

### 新特性迁移

#### 启用企业级日志
```json
{
  "logging": {
    "level": "INFO",
    "file": "./logs/app.log",
    "max_size_mb": 100,
    "max_backups": 10,
    "console_output": true
  }
}
```

#### 配置处理器参数
```json
{
  "processors": {
    "article_processor": {
      "batch_size": 20,
      "concurrent_workers": 5
    },
    "page_processor": {
      "template_dir": "./templates",
      "output_format": "hugo"
    }
  }
}
```

---

完成安装配置后，推荐使用"一键处理全部"功能体验完整的智能工作流！

有任何问题请查看日志文件或GitHub Issues。
- **预加载策略**: 批量操作时预加载相关缓存

## 日志和监控 (企业级)

### 结构化日志
```
2024-01-15 14:30:25.123 [INFO] [translator] 批量翻译开始
  type=tag_batch count=12 estimated_time=15s source=llm_translator.go:156

2024-01-15 14:30:26.456 [PERF] [cache] 缓存操作完成  
  operation=batch_load hit_rate=87.3% duration=0.02s source=cache.go:89

2024-01-15 14:30:27.789 [INFO] [workflow] 一键处理进度更新
  step=2/4 progress=50% current_operation="生成标签页面" source=workflow.go:67
```

### 性能监控指标
- **翻译性能**: 平均翻译时间、成功率、错误率
- **缓存性能**: 命中率、查询时间、内存占用
- **网络性能**: 请求延迟、重试次数、超时率
- **文件操作**: I/O时间、读写成功率

## 输出格式 (优化显示)

### 增强型进度条
```
🔄 批量翻译标签 (8/12) ████████░░░░ 67% [预计剩余: 6s]
  当前: "机器学习" -> "machine-learning"
  速度: 1.2项/秒 | 错误: 0 | 缓存命中: 4/8
```

### 性能仪表盘
```
📊 实时性能监控:
┌─────────────────┬──────────┬──────────┬──────────┐
│     指标        │   当前   │   平均   │   最佳   │
├─────────────────┼──────────┼──────────┼──────────┤
│ 翻译速度        │  1.2/s   │  1.1/s   │  1.8/s   │
│ 缓存命中率      │  87.3%   │  85.2%   │  92.1%   │
│ 网络延迟        │  1.18s   │  1.25s   │  0.89s   │
│ 内存使用        │  45MB    │  42MB    │  38MB    │
└─────────────────┴──────────┴──────────┴──────────┘
```

## 最佳实践 (性能优化)

### 使用建议
1. **首次使用**: 使用"一键处理全部"功能，系统会自动优化处理顺序，无需确认
2. **缓存管理**: 定期检查缓存状态，保持较高的命中率(>80%)
3. **批量操作**: 对于大量文章，其他功能会提供交互确认以避免误操作
4. **性能监控**: 定期查看性能统计，识别性能瓶颈
5. **网络优化**: 确保LM Studio连接稳定，避免频繁重试

### 交互确认策略
- **一键处理全部**: 完全自动化，无需确认 ⚡
- **其他所有功能**: 保留交互确认，确保用户控制 🛡️

### 性能优化技巧
1. **缓存预热**: 在批量操作前先生成全量缓存
2. **分批处理**: 设置合适的批量大小(默认20)，避免API限制
3. **并发控制**: 使用合理的并发数(默认5)，平衡速度和稳定性
4. **内存管理**: 定期清理不需要的缓存，控制内存占用
5. **错误处理**: 启用智能重试，提高操作成功率

### 高级配置
```json
{
  "performance": {
    "max_concurrent_requests": 5,
    "batch_size": 20,
    "memory_limit_mb": 512,
    "cache_hit_rate_threshold": 0.8,
    "enable_compression": true,
    "auto_cleanup": true
  },
  "monitoring": {
    "enable_performance_logging": true,
    "metrics_interval_seconds": 60,
    "slow_operation_threshold_ms": 5000
  }
}
```

## 故障排除

### 常见性能问题
1. **缓存命中率低**: 检查缓存文件完整性，考虑重新生成缓存
2. **翻译速度慢**: 检查网络连接，调整并发设置
3. **内存占用高**: 清理过期缓存，调整批量处理大小
4. **频繁重试**: 检查LM Studio状态，优化网络配置

详细故障排除请参考 [故障排除指南](troubleshooting.md)

## 相关文档

- [架构设计文档](architecture.md)
- [性能优化指南](performance.md)
- [缓存策略说明](caching.md)
- [配置文件说明](configuration.md)
- [日志系统指南](logging.md)
